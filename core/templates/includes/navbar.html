{% load static %}
{% load widget_tweaks %}

<!-- NAVBAR -->
<div class="container school-navbar d-flex align-items-center justify-content-between rounded-pill mt-4">
  <!-- Logo + Título -->
  <div class="d-flex align-items-center">
    <a href="{% url 'bienvenida' %}" class="navbar-brand fw-bold fs-4 mb-0 text-white d-flex align-items-center">
      <img src="{% static 'img/logo1.svg' %}" alt="logo avatar" style="width: 90px;" class="rounded-pill me-2">
      <span class="navbar-title">Agrícola Rural</span>
    </a>
  </div>

  <!-- Links -->
  <ul class="nav school-nav mx-auto">
    <li class="nav-item"><a class="nav-link" href="#sobre-nosotros">Sobre Nosotros</a></li>
    <li class="nav-item"><a class="nav-link" href="#noticias">Noticias</a></li>
    <li class="nav-item"><a class="nav-link" href="#galeria">Galería</a></li>
    <li class="nav-item"><a class="nav-link" href="#comunidad">Comunidad</a></li>
    <li class="nav-item"><a class="nav-link" href="#estadisticas">Estadísticas</a></li>
    <li class="nav-item"><a class="nav-link" href="#faq">FAQ</a></li>
    <li class="nav-item"><a class="nav-link" href="#contacto">Contacto</a></li>
  </ul>

  <!-- Botones o Usuario -->
  <div class="d-flex align-items-center">
    {% if user.is_authenticated %}
      <!-- Usuario autenticado -->
      <div class="dropdown">
        <button class="btn btn-light rounded-pill px-3 d-flex align-items-center gap-2 school-navbar-user-btn"
                data-bs-toggle="dropdown" aria-expanded="false">
          {% if user.perfil.foto %}
            <img src="{{ user.perfil.foto.url }}" class="rounded-circle me-2" width="36" height="36" style="object-fit:cover;">
          {% else %}
            <img src="{% static 'img/default_avatar.png' %}" class="rounded-circle me-2" width="36" height="36">
          {% endif %}
          <span class="fw-semibold text-success">Bienvenido, {{ user.perfil.primer_nombre }}</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end mt-2">
          <li><a class="dropdown-item" href="{% url 'perfil_usuario' %}"><i class="bi bi-person-circle me-2"></i>Perfil de Usuario</a></li>
          <li><a class="dropdown-item" href="{% url 'editar_perfil' %}"><i class="bi bi-pencil-square me-2"></i>Editar Perfil</a></li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <form method="post" action="{% url 'logout' %}">{% csrf_token %}
              <button type="submit" class="dropdown-item text-danger">
                <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
              </button>
            </form>
          </li>
        </ul>
      </div>
    {% else %}
      <!-- Usuario no autenticado -->
      <button class="school-navbar-login-btn me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Iniciar Sesión</button>
      <button class="school-navbar-register-btn" data-bs-toggle="modal" data-bs-target="#registroModal">Registrarse</button>
    {% endif %}
  </div>
</div>

<!-- ========================= -->
<!-- Modal Login -->
<!-- ========================= -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header border-0">
        <h5 class="modal-title text-white fw-bold">Iniciar Sesión</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">

        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show custom-alert" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
          {% endfor %}
        {% endif %}
        
        <form method="post" action="{% url 'login' %}">
          {% csrf_token %}
          {% with form=login_modal_form %}
            <div class="mb-3">
              <label for="{{ form.correo.id_for_label }}" class="form-label">Correo electrónico:</label>
              {% render_field form.correo class="form-control" id="id_login-correo" required="required" %}
              {% for error in form.correo.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>
            <div class="mb-3">
              <label for="{{ form.password.id_for_label }}" class="form-label">Contraseña:</label>
              {% render_field form.password class="form-control" id="id_login-password" required="required" %}
              {% for error in form.password.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
            </div>
          {% endwith %}
          <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary">Iniciar Sesión</button>
          </div>
        </form>
        <p class="small mt-3 text-center">¿No tienes cuenta? 
          <a href="#" class="modal-switcher" data-bs-target="#registroModal" data-bs-toggle="modal" data-bs-dismiss="modal">Regístrate aquí</a>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- Modal Registro -->
<!-- ========================= -->
<div class="modal fade" id="registroModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
    <div class="modal-content shadow">
      <div class="modal-header border-0">
        <h5 class="modal-title text-white fw-bold">Registro de Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">

        {% if registro_modal_form.non_field_errors %}
          <div class="alert alert-danger custom-alert">
            {% for error in registro_modal_form.non_field_errors %}
              <div>{{ error }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <form method="post" action="">
          {% csrf_token %}

          <!-- Correo -->
          <div class="mb-3">
            <label for="id_correo" class="form-label">Correo Electrónico:</label>
            {% render_field registro_modal_form.correo class="form-control" %}
            {% for error in registro_modal_form.correo.errors %}
              <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}
          </div>

          <!-- Rol -->
          <div class="mb-3">
            <label for="id_rol" class="form-label">Rol:</label>
            {% render_field registro_modal_form.rol class="form-select" id="id_rol" %}
            {% for error in registro_modal_form.rol.errors %}
              <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}
          </div>
          <div id="coordinador-alerta" class="alert alert-warning py-2 px-3 mb-3 d-none small">
            ⚠️ Tu cuenta será revisada por un Superusuario antes de poder ingresar.
          </div>

          <!-- Documento -->
          <div class="row g-3">
            <div class="col-md-6 mb-3">
              <label for="id_tipo_documento" class="form-label">Tipo de Documento:</label>
              {% render_field registro_modal_form.tipo_documento class="form-select" %}
              {% for error in registro_modal_form.tipo_documento.errors %}
                <div class="text-danger small mt-1">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-6 mb-3">
              <label for="id_numero_documento" class="form-label">Número de Documento:</label>
              {% render_field registro_modal_form.numero_documento class="form-control" %}
              {% for error in registro_modal_form.numero_documento.errors %}
                <div class="text-danger small mt-1">{{ error }}</div>
              {% endfor %}
            </div>
          </div>

          <!-- País / Depto / Municipio -->
          <div class="mb-3">
            <label for="id_pais_identificacion" class="form-label">País:</label>
            {% render_field registro_modal_form.pais_identificacion class="form-select" %}
            {% for error in registro_modal_form.pais_identificacion.errors %}
              <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="mb-3">
            <label for="id_departamento_identificacion" class="form-label">Departamento:</label>
            {% render_field registro_modal_form.departamento_identificacion class="form-select" %}
            {% for error in registro_modal_form.departamento_identificacion.errors %}
              <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="mb-3">
            <label for="id_municipio_identificacion" class="form-label">Municipio:</label>
            {% render_field registro_modal_form.municipio_identificacion class="form-select" %}
            {% for error in registro_modal_form.municipio_identificacion.errors %}
              <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}
          </div>

          <!-- Password -->
          <div class="mb-3 position-relative">
            <label for="id_password" class="form-label">Contraseña:</label>
            {% render_field registro_modal_form.password class="form-control pe-5" %}
            <button type="button"
                    onclick="togglePasswordIcon('id_password', this)"
                    class="btn btn-link position-absolute"
                    style="top: 2.1rem; right: 0.25rem;" tabindex="-1">
              <i class="bi bi-eye-slash fs-5" aria-label="Mostrar contraseña"></i>
            </button>
            {% for error in registro_modal_form.password.errors %}
              <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}

            <!-- Barra de progreso -->
            <div class="progress my-2 password-progress" style="height: 5px;">
              <div id="password-strength" class="progress-bar bg-danger" style="width: 0%"></div>
            </div>
           <ul class="password-rules list-unstyled">
              <li id="len" class="password-rule">✔️ Al menos 8 caracteres</li>
              <li id="mayus" class="password-rule">✔️ Una letra mayúscula</li>
              <li id="minus" class="password-rule">✔️ Una letra minúscula</li>
              <li id="num" class="password-rule">✔️ Un número</li>
              <li id="sym" class="password-rule">✔️ Un símbolo especial (# $ % ! _)</li>
            </ul>
          </div>

          <!-- Confirmar -->
          <div class="mb-3 position-relative">
            <label for="id_confirmar_password" class="form-label">Confirmar Contraseña:</label>
            {% render_field registro_modal_form.confirmar_password class="form-control pe-5" %}
            <button type="button"
                    onclick="togglePasswordIcon('id_confirmar_password', this)"
                    class="btn btn-link position-absolute"
                    style="top: 2.1rem; right: 0.25rem;" tabindex="-1">
              <i class="bi bi-eye-slash fs-5" aria-label="Mostrar contraseña"></i>
            </button>
            {% for error in registro_modal_form.confirmar_password.errors %}
              <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="d-grid mt-4">
            <button type="submit" name="registro" class="btn btn-primary">Registrarse</button>
          </div>
        </form>

        <p class="small mt-3 text-center">¿Ya tienes cuenta? 
          <a href="#" class="modal-switcher"
             data-bs-target="#loginModal"
             data-bs-toggle="modal"
             data-bs-dismiss="modal">Inicia sesión</a>
        </p>
      </div>
    </div>
  </div>
</div>


{% block extra_js %}

  <script src="{% static 'js/modal.js' %}"></script>
  <script src="{% static 'js/registro.js' %}"></script>
  <script src="{% static 'js/login.js' %}"></script>


  {% if registro_modal_form.errors %}
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const registroModal = new bootstrap.Modal(document.getElementById("registroModal"));
        registroModal.show();
      });
    </script>
  {% endif %}

  {% if login_modal_form.errors or request.GET.login %}
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const loginModal = new bootstrap.Modal(document.getElementById("loginModal"));
        loginModal.show();
      });
    </script>
  {% endif %}

{% endblock %}
